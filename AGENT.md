# AGENT.md — Garmin Connect IQ Data Field「Coach Message」(FR255)
※1リポジトリで「Training(無料)」「Race(有料)」をビルド切替して配布する  
※メッセージ文体：軽めの大阪弁（JPN）  
※多言語は “直訳しない。ノリ合わせ” を最優先

---

## 0. 目的
Garmin Forerunner 255向け Connect IQ **Data Field** を開発する。  
アクティビティ中に、以下3軸でメッセージを出し分ける：

1) **坂（上り/平坦/下り）**  
2) **心拍ゾーン（Z1–Z5）**  
3) **距離イベント（節目：1kmごと＋特別節目）**

- **Training版（無料）**：面白/塩/酒/毒など多め、更新頻度高め  
- **Race版（有料）**：定番/注意喚起/褒め中心、更新頻度低め、レース実用寄り  
- **同一リポジトリ**で管理し、ビルド時に `training.iq` / `race.iq` を生成する

---

## 1. 対象
- デバイス：Garmin Forerunner 255
- App Type：Connect IQ **Data Field**
- ネットワーク：不要（通信なし）
- 取得データ：心拍、距離、高度、時間（アクティビティ中）

---

## 2. 言語対応（5言語）
- 日本語（JPN）
- 英語（ENG）
- スペイン語（SPA）
- フランス語（FRE）
- ドイツ語（DEU）

方針：
- UIラベル類（設定名、状態表示など）は `resources-xxx/strings.xml`
- **メッセージ本文は言語別配列データ**で保持（strings.xml肥大化回避）
- `AUTO`（端末言語追従）固定

ファイル：
- `source/messages/messages_jpn.mc`
- `source/messages/messages_eng.mc`
- `source/messages/messages_spa.mc`
- `source/messages/messages_fre.mc`
- `source/messages/messages_deu.mc`

※このAGENT.mdには **日本語（大阪弁）メッセージ本文**を同梱し、他言語は同じキー構造で翻訳配置する。

---

## 3. モードと配布（Training無料 / Race有料）
- 1リポジトリ、2つのmanifest（UUID別）でストア上は別アプリ
- `training.iq`：無料
- `race.iq`：有料（Monetization）

---

## 4. Data Field内の描画（1枠のみ）
推奨描画（短文が基本）：
- 1行目：メッセージ（目安 14〜18文字、超過は短縮）
- 2行目（任意/小）：状態短縮（例 `UP Z3` / `FL Z2` / `DN Z4` / `5.0km`）

---

## 5. 入力データ
必須：
- 心拍（bpm）
- 距離（m）
- 経過時間
- 高度（m）または近似できる値
- （補助）速度 or 距離差分

---

## 6. 判定ロジック
### 6.1 心拍ゾーン（Z1–Z5）
- 設定：`hr_max`（default 190）
- `hrp = hr_now / hr_max`
- デフォルト閾値：
  - Z1 < 60%
  - Z2 60–70%
  - Z3 70–80%
  - Z4 80–90%
  - Z5 >= 90%

### 6.2 坂（上り/平坦/下り）
- 直近W秒（例：15秒）の高度差と距離差で近似
- `grade = delta_altitude / delta_distance`
- 判定：
  - UP：`grade >= +0.03`
  - DN：`grade <= -0.03`
  - FL：それ以外
- ノイズ対策：
  - `delta_distance < 20m` の場合は更新しない
  - gradeは平滑化（EMAなど）して良い

### 6.3 状態キー（坂×心拍）
- `state_key = {UP|FL|DN}_Z{1..5}`

---

## 7. 距離イベント（節目メッセージ）
### 7.1 イベント定義
- **1kmごと**（1,2,3,...）で軽めの節目メッセージ
- 特別節目：`5, 10, 15, 20, 21.1, 25, 30, 35, 40, 42.2`

### 7.2 発火条件
- `distance_km` が閾値を **初めて超えた瞬間**に1回だけ
- `last_km_event` を保存して二重発火を防止
- 誤差許容：`>= threshold - 0.02`

### 7.3 優先度
- DISTは基本最優先表示
- Race版のみ「危険警告（例：DN×Z5）」がある場合は警告優先、DISTは次回へ繰り越し可

---

## 8. メッセージ選択（カテゴリ）
カテゴリ：
- 定番（FIXED）
- 面白（FUNNY）
- 塩対応（SALT）
- 酒（ALCOHOL）
- 毒（TOXIC）
- 褒めちぎり（PRAISE）
- 距離イベント（DIST）

### 8.1 Training版（無料）
- 更新頻度：10〜15秒、または `state_key` 変化時（最短間隔5秒）
- カテゴリ比率（例）
  - FUNNY 25%
  - SALT 20%
  - ALCOHOL 20%
  - TOXIC 10%
  - FIXED 15%
  - PRAISE 10%
- DISTは発火時に割り込み表示

### 8.2 Race版（有料）
- 更新頻度：20〜30秒、またはラップ/イベント時
- カテゴリ比率（例）
  - FIXED 55%
  - PRAISE 25%
  - WARN（FIXED内サブセット）15%
  - FUNNY 5%
  - SALT/TOXIC/ALCOHOL 原則0%
- DISTは割り込み表示（危険警告は優先）

---

## 9. 翻訳（ENG/SPA/FRE/DEU）方針 — “直訳禁止、ノリ優先”
### 9.1 共通ルール
- **大阪弁の直訳はしない**  
  → その言語で自然な “軽口・フレンドリー・ちょいツッコミ” に変換する
- 1文は短く：**目安 12〜20文字/文字相当**（英語は単語数で 3〜6語程度を目標）
- 罵倒・人格否定は避ける（SALT/TOXICも “笑える範囲”）
- ラン中なので **読み返し不要**な単語を選ぶ（難語・長文禁止）
- 可能なら韻・リズム・決め台詞で “スクショ映え” を狙う

### 9.2 トーンの目安（言語別）
#### ENG（英語）
- トーン：casual / cheeky / supportive  
- よく使う型：
  - “Easy does it.” “You got this.” “Hold it.” “Breathe.”  
  - “Too hot—dial it back.” “Smooth and steady.”  
  - 皮肉は薄め（dry humor程度）
- NG：スラング強すぎ、罵倒、長文

#### SPA（スペイン語）
- トーン：amistoso / directo / con humor ligero  
- よく使う型：
  - “Tranquilo.” “Vamos.” “Respira.” “Suave.”  
  - “No te pases.” “Buen ritmo.”  
- 感嘆符は使いすぎない（短文を優先）

#### FRE（フランス語）
- トーン：léger / taquin / motivant  
- よく使う型：
  - “Allez.” “Respire.” “Calme.” “Ça roule.”  
  - “Trop vite—doucement.” “Garde le rythme.”  
- 皮肉は “taquin” 程度に抑える

#### DEU（ドイツ語）
- トーン：kurz / klar / freundlich-ironisch  
- よく使う型：
  - “Locker.” “Weiter so.” “Atmen.” “Ruhig.”  
  - “Zu schnell—runter.” “Sauber laufen.”  
- 長い複合語は避ける（読みづらい）

### 9.3 カテゴリ別の翻訳指針
- FIXED：実用優先（指示が明確）
- PRAISE：短く褒める（過剰にしない）
- FUNNY：文化依存ネタは各言語で置換（酒ネタ等は残してOK）
- SALT：冷たい “事実指摘” に寄せる（人格否定NG）
- TOXIC：煽りすぎない “辛口コメント” に寄せる
- ALCOHOL：各言語の定番表現を使う（ただし未成年・危険飲酒を煽る表現は避ける）

### 9.4 距離イベント（DIST）の翻訳
- 数字＋短いリアクションが最強
  - 例（ENG）：“5K already—nice!” “10K done. Easy.”  
  - 例（SPA）：“¡5 km ya!” “10 km, muy bien.”  
  - 例（FRE）：“5 km déjà !” “10 km, nickel.”  
  - 例（DEU）：“Schon 5 km!” “10 km, stark.”

### 9.5 変換例（指針の確認用）
JPN「もう5キロやん、早っ！」  
- ENG：“5K already—nice!”  
- SPA：“¡5 km ya! ¡Bien!”  
- FRE：“5 km déjà—top !”  
- DEU：“Schon 5 km—stark!”

---

## 10. 文章データ構造（推奨）
- 状態別：
  - `MESSAGES_STATE[state_key][category] = [ ... ]`
- 距離イベント：
  - `MESSAGES_DIST[km_marker] = [ ... ]`
- `km_marker` は `"1" "2" ... "21.1" "42.2"` の文字列キー

重複回避：
- 直近N件（例5件）と同じ文字列は避ける

---

# 11. メッセージ本文（日本語・軽め大阪弁）

## 11.1 DIST（距離イベント：1kmごと＋特別節目）
方針：短く、気分上げる／軽くツッコむ。  
※各kmは候補2本（特別節目は3本）。

### 1–4km（各2本）
- 1km：  
  - 「1キロ突破やで。ええ入り！」  
  - 「1キロやん。肩の力ぬこ」
- 2km：  
  - 「2キロ。まだ余裕あるやろ」  
  - 「2キロ到達。ええペースやん」
- 3km：  
  - 「3キロ。リズムそのままやで」  
  - 「3キロ、ええ感じに温まったな」
- 4km：  
  - 「4キロ。焦らんでええよ」  
  - 「4キロ。呼吸、ゆったりな」

### 特別節目（3本）
- 5km：  
  - 「もう5キロやん、早っ！」  
  - 「5キロ到達。余裕顔いけるで」  
  - 「5キロ。ここからが本番やな」
- 10km：  
  - 「10キロ到達。調子ええな」  
  - 「10キロ。まだまだいけるやろ」  
  - 「10キロ。水いこ、水」
- 15km：  
  - 「15キロ。ええ積み上げやで」  
  - 「15キロ。足、よう動いとる」  
  - 「15キロ。ここは丁寧にいこ」
- 20km：  
  - 「20キロ。半分見えてきたで」  
  - 「20キロ。焦らず貯金や」  
  - 「20キロ。いったん整えよ」
- 21.1km：  
  - 「ハーフ超えた！ここから味や」  
  - 「21.1。後半戦、入るで」  
  - 「ハーフ通過。落ち着いていこ」
- 25km：  
  - 「25キロ。ここで雑にならんとこ」  
  - 「25キロ。補給、忘れてへん？」  
  - 「25キロ。えらい、ほんまえらい」
- 30km：  
  - 「30キロ。ここ踏ん張れたら勝ちや」  
  - 「30キロ。勝負どころ来たで」  
  - 「30キロ。呼吸整えて、いこ」
- 35km：  
  - 「35キロ。ようやっとる、マジで」  
  - 「35キロ。崩れんでええで」  
  - 「35キロ。あと少しずつや」
- 40km：  
  - 「40キロ。あとちょい、いこ」  
  - 「40キロ。もうゴール見えてるで」  
  - 「40キロ。最後、丁寧にな」
- 42.2km：  
  - 「完走や！ほんまにやったな」  
  - 「42.2。えぐい。拍手やで」  
  - 「ゴール！今日の主役、きみや」

### 6–9km / 11–14km / 16–19km / 22–24km / 26–29km / 31–34km / 36–39km / 41km（各2本）
- 6km：「6キロ。ええ流れ続いてるで」「6キロ。力みゼロでいこ」  
- 7km：「7キロ。ピッチだけ意識な」「7キロ。顔、ゆるめとこ」  
- 8km：「8キロ。ええやん、その安定感」「8キロ。淡々が最強やで」  
- 9km：「9キロ。次で10や、落ち着け」「9キロ。呼吸深うな」  
- 11km：「11キロ。まだ序盤の顔でいこ」「11キロ。今は温存やで」  
- 12km：「12キロ。リズム勝ちやな」「12キロ。肩、落としてこ」  
- 13km：「13キロ。ええ感じにしんどいな」「13キロ。雑にならんで」  
- 14km：「14キロ。足、回すだけでええ」「14キロ。次、15やで」  
- 16km：「16キロ。ここで焦らんとこ」「16キロ。淡々続けよ」  
- 17km：「17キロ。ええやん、粘れてる」「17キロ。水、そろそろやで」  
- 18km：「18キロ。フォーム、きれいめ意識」「18キロ。余計な力いらん」  
- 19km：「19キロ。20見えた、落ち着こ」「19キロ。呼吸、整えよ」  
- 22km：「22キロ。ここから大人の走りや」「22キロ。上げんでええで」  
- 23km：「23キロ。一定、一定やで」「23キロ。心拍、暴れたらアカン」  
- 24km：「24キロ。まだいける、まだいける」「24キロ。足、丁寧にな」  
- 26km：「26キロ。しんどいの普通やで」「26キロ。呼吸、深う」  
- 27km：「27キロ。今は守りで勝つ」「27キロ。水いこ、水」  
- 28km：「28キロ。焦らん。淡々や」「28キロ。腕、軽く振ろ」  
- 29km：「29キロ。次で30や、整えよ」「29キロ。フォーム戻そか」  
- 31km：「31キロ。いまが踏ん張り所や」「31キロ。崩れんでええ」  
- 32km：「32キロ。無理せんで強いぞ」「32キロ。呼吸からやで」  
- 33km：「33キロ。雑になりやすい、注意」「33キロ。足音、静かに」  
- 34km：「34キロ。あと少しずつ、刻も」「34キロ。ここ耐えよ」  
- 36km：「36キロ。えらい、ほんまに」「36キロ。いったん整えよ」  
- 37km：「37キロ。いま勝ってるで」「37キロ。崩れたら戻そ」  
- 38km：「38キロ。小さく攻めよ」「38キロ。呼吸、落ち着け」  
- 39km：「39キロ。次で40、いける」「39キロ。あとちょいずつ」  
- 41km：「41キロ。あと1キロやで！」「41キロ。最後、丁寧にいこ」

---

## 11.2 状態メッセージ（坂×心拍×カテゴリ）
※各 `state_key` に対してカテゴリごと2本ずつ（最低限）

### UP_Z1
- FIXED：「上りは温存でええで」「ピッチだけ揃えよか」
- FUNNY：「坂、まだ本気出してへん」「登りは課金ステージやで」
- SALT：「登り。以上」「無駄に上げるな」
- ALCOHOL：「登りは薄めでいこ」「坂は濃いめ注意やで」
- TOXIC：「坂に媚びたら負けやで」「余裕あるうちに整えとき」
- PRAISE：「上りで余裕、強いわ」「ええ登り方してるで」

### UP_Z2
- FIXED：「腕振ってリズム作ろ」「呼吸、深めでいこ」
- FUNNY：「坂、今日も元気やな」「心拍、まだ優等生」
- SALT：「そこで焦るな」「登りでイキるな」
- ALCOHOL：「ここ越えたら一杯や」「レモン多めの気分や」
- TOXIC：「今上げたら後で泣くで」「貯金はここで使うな」
- PRAISE：「ええ粘りやん」「登り安定してるわ」

### UP_Z3
- FIXED：「腕で引っ張っていこ」「歩幅よりピッチやで」
- FUNNY：「心拍が先に登頂してる」「坂、やりすぎやん」
- SALT：「顔、死んでるで」「力みすぎ」
- ALCOHOL：「この坂、つまみ強いな」「今飲んだら倒れるで」
- TOXIC：「根性で押すな、整えろ」「雑になるな、丁寧に」
- PRAISE：「粘りが武器やな」「ええ根性しとる」

### UP_Z4
- FIXED：「いったん落とそか」「呼吸整えて耐えよ」
- FUNNY：「坂が法律違反やわ」「ここ、地獄の入口やで」
- SALT：「それ、無理してる」「はい減速」
- ALCOHOL：「チェイサー挟め」「水で乾杯しとけ」
- TOXIC：「壊す気？」「その攻め、危険物」
- PRAISE：「踏ん張れてるの本物や」「キツいのに進めてる」

### UP_Z5
- FIXED：「落として整えよ」「いったん守ろ、守り」
- FUNNY：「坂、反省して？」「心拍、暴れすぎやで」
- SALT：「黙って減速」「危ない」
- ALCOHOL：「今飲んだら記憶飛ぶ」「休肝日確定やな」
- TOXIC：「やめとき、壊れる」「今は勝負ちゃう」
- PRAISE：「限界で動けるの凄い」「気持ちが強いわ」

### FL_Z1
- FIXED：「楽に刻めてるで」「フォームだけ意識しよ」
- FUNNY：「いま無敵感あるやん」「散歩ちゃうで、練習やで」
- SALT：「楽そうやな」「まだやで」
- ALCOHOL：「今なら一杯いける気する」「とりあえず水な」
- TOXIC：「それ、ぬるいぞ」「余裕あるなら丁寧に」
- PRAISE：「気持ちよく走れてる」「ええリズムやで」

### FL_Z2
- FIXED：「目標ペース維持やで」「呼吸、ゆったりな」
- FUNNY：「そのまま優勝でええ？」「安定感が仕事してる」
- SALT：「普通。続けて」「上げんでええ」
- ALCOHOL：「ハイボールの口やん」「炭酸強めで頼むわ」
- TOXIC：「取り返すなよ」「貯金を崩すな」
- PRAISE：「安定感あるわ」「淡々が最強やで」

### FL_Z3
- FIXED：「呼吸深うしていこ」「肩、落としてな」
- FUNNY：「いい感じにしんどいな」「心拍、主張強め」
- SALT：「まだ足りん」「顔固いで」
- ALCOHOL：「この強度、つまみ欲しい」「チェイサー挟んどこ」
- TOXIC：「雑になるな」「ここで見栄張るな」
- PRAISE：「集中できてる」「ええ粘りやん」

### FL_Z4
- FIXED：「上げすぎ注意やで」「いったん整えよ」
- FUNNY：「心拍、反抗期きた」「ここが地獄かも」
- SALT：「上げすぎ」「落とせって」
- ALCOHOL：「飲む前に落ち着こ」「水いけ、水」
- TOXIC：「今上げたら後で死ぬで」「誰と戦ってるん」
- PRAISE：「攻めれてる、ええで」「強気やけど丁寧にな」

### FL_Z5
- FIXED：「一回落とそか」「呼吸だけ見よ」
- FUNNY：「心拍、暴走族やん」「現実、厳しいな」
- SALT：「落とせ」「終わらへんで」
- ALCOHOL：「休肝日、確定」「今飲んだら倒れる」
- TOXIC：「無謀やで」「壊す気かいな」
- PRAISE：「ここまで来たの天才」「魂が走ってるわ」

### DN_Z1
- FIXED：「下りはフォーム優先やで」「力抜いて流そ」
- FUNNY：「下り、無料で速いな」「坂の恩返しきた」
- SALT：「下りで得意顔」「浮かれんな」
- ALCOHOL：「泡立ってきたな」「ジョッキ見えてきた」
- TOXIC：「調子乗ると終わるで」「下りだけ強いな」
- PRAISE：「フォームきれいやで」「余裕のスピードやん」

### DN_Z2
- FIXED：「着地は静かにな」「流す感じでええ」
- FUNNY：「脚が勝手に走るやつ」「下り、チートやん」
- SALT：「浮かれるな」「雑やで」
- ALCOHOL：「レモン多めで頼む」「一杯のために丁寧にな」
- TOXIC：「膝、泣くで」「ここで壊すな」
- PRAISE：「下り上手いやん」「コントロールできてる」

### DN_Z3
- FIXED：「スピード上げすぎんとこ」「着地、静かに」
- FUNNY：「調子乗るな警報」「ブレーキどこいった」
- SALT：「着地が雑」「見てられへん」
- ALCOHOL：「飲む前に落ち着け」「炭酸きつめが似合う」
- TOXIC：「膝が泣くぞ」「無駄に攻めるな」
- PRAISE：「ええ流し方や」「余裕あるの強い」

### DN_Z4
- FIXED：「オーバーペースやで」「いったん落とそ」
- FUNNY：「下りで心拍Z4は草」「勝手に加速すな」
- SALT：「壊す気？」「ブレーキ使え」
- ALCOHOL：「今飲んだら危ない」「水で乾杯しとけ」
- TOXIC：「無謀や」「膝、終了するで」
- PRAISE：「攻めれてるけど丁寧にな」「怖いのに進めてる」

### DN_Z5
- FIXED：「危険や、落とそか」「安全第一やで」
- FUNNY：「それ事故るやつやん」「心拍、天井やで」
- SALT：「事故るぞ」「やめとけ」
- ALCOHOL：「今飲んだら記憶消える」「ラストオーダー級」
- TOXIC：「無謀すぎ」「何してんの」
- PRAISE：「ここまで来たの凄い」「落ち着けたら勝ちや」

---

## 11.3 WARN（Race版優先：注意喚起セット）
- 「今は落とそ。レースは長いで」
- 「呼吸整えよ。焦らんでええ」
- 「下りで上げすぎ。壊したら損やで」
- 「心拍高すぎ。いったん整えよ」
- 「フォーム戻そか。雑は禁物や」
- 「水いこ。忘れたら後で詰むで」
- 「補給しよ。今が一番安い」
- 「ここは我慢。後半で勝つで」
- 「上げるなら、もうちょい後や」
- 「落ち着けたら勝ち。ほんまに」

---

## 12. 実装メモ（Codex CLI向け）
- まず `messages_jpn.mc` をこのAGENT.mdの 11章から生成する
- 他言語は 9章の指針に従い、短文・軽口で翻訳して同じキーに格納する
- 表示文字数制限に備え、描画時に簡易トリム（末尾 `…`）を実装する

---

## 13. 開発順序（最小単位実装・都度確認）
### 13.1 開発原則
1. 一度に作り込まない。1機能ずつ実装して毎回動作確認する。
2. `Training版` を先に完成させ、`Race版` は差分実装で後追いする。
3. 各ステップで `Build Current Project` 成功、`fr255_sim` で表示確認、ログに例外なしを完了条件にする。
4. 失敗時は直前ステップの成功状態まで戻してから原因修正し、次ステップへ進む。
5. 1ステップごとにスコープを固定し、未着手機能は明示的に後工程へ回す。

### 13.2 実装ステップ順
- Step 0: Data Field最小表示（`Grow` 等の固定文字）を維持して土台確認。
- Step 1: 心拍取得とZ1–Z5判定のみ実装。表示は `Zx` 固定フォーマット。
- Step 2: 坂判定（UP/FL/DN）のみ追加。表示は `UP Z3` 形式。
- Step 3: `state_key` 生成と `FIXED` カテゴリ1本選択を実装。
- Step 4: `Training` カテゴリ比率（FUNNY/SALT/ALCOHOL/TOXIC/FIXED/PRAISE）を実装。
- Step 5: 距離イベント（1kmごと + 特別節目）を実装し、DIST割り込み表示を追加。
- Step 6: 重複回避（直近N件）と最短更新間隔（5秒）を実装。
- Step 7: 表示文字数トリム（末尾 `…`）を実装。
- Step 8: `Race` 差分（比率、WARN優先、更新間隔20–30秒）を実装。
- Step 9: 多言語配列（ENG/SPA/FRE/DEU）を同キー構造で追加。

### 13.3 各ステップのDoD（Definition of Done）
- 実装対象外機能を混ぜない。
- 手動確認項目を1つ以上追加または更新する。
- 変更理由を1行で残す（コミットメッセージまたは作業メモ）。

### 13.4 内部インターフェース方針（実装単位）
- `computeContext(info) -> {hrZone, slopeState, stateKey, distanceKm}`
- `pickMessage(mode, context, now) -> String`
- `shouldFireDistanceEvent(distanceKm, lastKmEvent) -> Boolean`

### 13.5 テストケースと確認シナリオ
1. Step 1: 心拍値境界（59%, 60%, 70%, 80%, 90%）でゾーンが期待どおり。
2. Step 2: `grade` が `+0.03/-0.03` 境界でUP/DN/FLが期待どおり。
3. Step 5: `distance_km` が閾値初回通過時のみDIST発火し、二重発火しない。
4. Step 6: 同一文言が直近N件内で再選択されない。
5. Step 8: Raceで危険警告がDISTより優先される。
6. 全Step共通: ビルド成功、表示崩れなし、クラッシュなし。
